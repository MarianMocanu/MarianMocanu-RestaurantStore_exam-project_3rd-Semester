<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout (~{::body},'shop')}">
<body>

<div class="container">
    <div class="row products-row">
        <div class="col-8 mx-auto">
        <form action="/shop" method="get" class="input-group">
            <input class="form-control form-control-dark" type="text" placeholder="Search" name="search"
                   aria-label="Search">
            <div class="input-group-append">
                <button class="btn btn-info" value="Search">Search</button>
            </div>
        </form>
        </div>
    </div>

    <div class="row products-row text-center">
        <div class="col">
            <div class="dropdown">
                <button class="btn btn-info w-100 dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                    Categories
                </button>
                <div class="dropdown-menu w-100" aria-labelledby="dropdownMenuButton">
                    <a class="dropdown-item" href="/">All Categories</a>
                    <th:block th:each="category : ${allCategories}">
                        <a class="dropdown-item" th:href="'/shop?cat=' + ${category.getId()}" th:text="${category}"></a>
                    </th:block>
                </div>
            </div>
        </div>
        <div class="col">
            <a href="/admin/product/add" class="btn btn-info w-100">Add Product</a>
        </div>
        <div class="col">
            <input type="number" id="minPrice" placeholder="Min price"/>
            <input type="number" id="maxPrice" placeholder="Max price"/>
        </div>
    </div>


    <div class="row products-row text-center justify-content-center">
        <th:block th:if="${noProducts}">
            <h3>No products matched your query</h3>
        </th:block>
        <th:block th:unless="${noProducts}">
        <div class="card card-products rounded bg-dark" style="width: 18rem;" th:each="product: ${products}">
            <img th:src="${product.images.isEmpty()} ? '../images/defaultImage.jpg' : ${product.images[0].url}" class="card-img-top">
            <div class="card-body card-body-product-main">
                <h5 class="card-title product-name"><a th:href="'/product/' + ${product.id}"
                                          th:text="${product.name}"></a></h5>
                <p class="card-text" th:text="${product.description}"></p>
            </div>
            <ul class="card-body list-group list-group-flush">
                <li class="list-group-item bg-dark price"
                    th:text="'Price: ' + (${product.prices.isEmpty()} ? '0!!!' : ${product.prices[0].getPrice()}) + ' DKK'"></li>
                <li class="list-group-item bg-dark" th:text="'Category: ' + ${product.category}"></li>
            </ul>
            <div class="card-body">
            <form action="/addToBasket" method="post">
                <input type="hidden" name="productId" th:value="${product.id}">
                <input type="hidden" name="quantity" value="1">
                <button type="submit" class="btn btn-info">Add to cart</button>
            </form>
            </div>
            <div class="card-body card-body-product-links">
                <a th:href="'/admin/product/edit/' + ${product.id}" class="card-link btn btn-info">Edit</a>
                <a th:href="'/admin/product/delete/' + ${product.id}" class="card-link btn btn-info">Delete</a>
            </div>
        </div>
        </th:block>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous"></script>
<script>
    $(document).ready(function () {
        let minPrice = document.querySelector("#minPrice");
        let maxPrice = document.querySelector("#maxPrice");

        minPrice.addEventListener('input', function () {
            setTimeout(function () {
                filterPrice(minPrice.value, maxPrice.value);
            }, 1500);

        });

        maxPrice.addEventListener('input', function () {
            setTimeout(function () {
                filterPrice(minPrice.value, maxPrice.value);
            }, 1500);
        });

        function filterPrice(min, max) {
            //Get all elements that have the class price
            let pricesString = document.querySelectorAll(".price");
            //Iterate over them
            for (let priceString of pricesString) {
                //Extract digits from the field
                let price = priceString.innerHTML.replace(/[^,.0-9]/g, "");
                //Convert the price, the min value and the max value to int
                price = parseFloat(price);
                min = parseFloat(min);
                max = parseFloat(max);

                if (isNaN(min)) {
                    min = 0;
                }
                if (isNaN(max)) {
                    if (price >= min) {
                        priceString.parentElement.parentElement.style.display = "block";
                    } else {
                        priceString.parentElement.parentElement.style.display = "none";
                    }
                } else if (price >= min && price <= max) {
                    priceString.parentElement.parentElement.style.display = "block";
                } else {
                    priceString.parentElement.parentElement.style.display = "none";
                }
            }
        }

    });
</script>
</body>
</html>
